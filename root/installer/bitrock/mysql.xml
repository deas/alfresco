<!-- MYSQL1.0
Componentname: MySQL

Short Description:
This component is able to install and configurate the bundled MySQL binaries it carries, 
or to configure an existing MySQL server.

System variables provided by this component:

  * database_vendor (mysql)
  * database_language (sql)
  * database_port
  * database_hostname
  * database_root_user
  * database_root_password
  * database_binary_directory
  * database_root_directory
  * database_upgrade
  * component(mysql).mysql_installation_type_options -> bundled / existing / bundledAndExisting (default if var is not set)
  

-->
<component>
    <name>mysql</name>
    <description>MySQL</description>
    <canBeEdited>1</canBeEdited>
    <detailedDescription>MySQL software delivers a very fast, multi-threaded, multi-user, and robust SQL database server.</detailedDescription>
    <selected>1</selected>
    <show>0</show>
    <initializationActionList>
        <addChoiceOptions>
            <name>mysql_installation_type</name>
            <optionList>
                <option>
                    <text>I wish to use the bundled MySQL database</text>
                    <value>bundled</value>
                </option>
            </optionList>
            <ruleList>
                <compareText text="${component(mysql).parameter(mysql_installation_type_options).value}" logic="equals" value="bundled"/>
            </ruleList>
        </addChoiceOptions>
        <addChoiceOptions>
            <name>mysql_installation_type</name>
            <optionList>
                <option>
                    <text>I wish to use an existing MySQL database</text>
                    <value>existing</value>
                </option>
            </optionList>
            <ruleList>
                <compareText text="${component(mysql).parameter(mysql_installation_type_options).value}" logic="equals" value="existing"/>
            </ruleList>
        </addChoiceOptions>
        <addChoiceOptions>
            <name>mysql_installation_type</name>
            <optionList>
                <option>
                    <text>I wish to use the bundled MySQL database</text>
                    <value>bundled</value>
                </option>
                <option>
                    <text>I wish to use an existing MySQL database</text>
                    <value>existing</value>
                </option>
            </optionList>
            <ruleList>
                <compareText text="${component(mysql).parameter(mysql_installation_type_options).value}" logic="equals" value="bundledAndExisting"/>
            </ruleList>
        </addChoiceOptions>
    </initializationActionList>
    <preInstallationActionList>
        <getFreePort variable="mysql_port" initialPort="${component(mysql).parameter(mysql_information).parameter(mysql_initial_port).value}" finalPort="${component(mysql).parameter(mysql_information).parameter(mysql_final_port).value}">
            <abortOnError>0</abortOnError>
            <showMessageOnError>0</showMessageOnError>
            <ruleList>
                <compareText text="${mysql_automatic_port_selection}" logic="equals" value="1" />  
            </ruleList>
        </getFreePort>
    </preInstallationActionList>
    <installationAbortedActionList>
<!-- WINDOWS -->
<actionGroup>
            <actionList>
                <runProgram>
                    <abortOnError>0</abortOnError>
                    <showMessageOnError>0</showMessageOnError>
                    <program>sc</program>
                    <programArguments>stop ${mysql_unique_service_name}</programArguments>
                </runProgram>
                <runProgram>
                    <abortOnError>0</abortOnError>
                    <showMessageOnError>0</showMessageOnError>
                    <program>sc</program>
                    <programArguments>delete ${mysql_unique_service_name}</programArguments>
                </runProgram>
                <deleteFile path="${installdir}/mysql/data" />
                <deleteFile path="${installdir}/mysql" />
            </actionList>
            <ruleList>
                <compareText text="${mysql_execute_abort_action_list}" value="1" logic="equals"/>
                <platformTest type="windows"/>
            </ruleList>
        </actionGroup>

<!-- LINUX -->
<actionGroup>
            <actionList>
                <deleteFile path="${mysql_server_directory}">
                    <ruleList>
                        <compareText text="${mysql_installation_type}" logic="equals" value="bundled"/>
                    </ruleList>
                </deleteFile>
            </actionList>
            <ruleList>
                <compareText text="${mysql_execute_abort_action_list}" value="1" logic="equals"/>
                <platformTest type="linux"/>
            </ruleList>
        </actionGroup>
    </installationAbortedActionList>

    <parameterList>

        <booleanParameter name="mysql_abort_installation_on_initialization_error" value="0" ask="0" />
        <booleanParameter name="mysql_execute_abort_action_list" value="0" ask="0" />


        <stringParameter>
            <name>mysql_global_port_checking</name>
            <value>0</value>
            <ask>0</ask>
            <default/>
        </stringParameter>
        
        <stringParameter>
            <name>mysql_alphanumeric_password</name>
            <ask>0</ask>
            <default>1</default>
            <value>1</value>
        </stringParameter>
        <!-- If we want to restrict for instance russians charaters, we need to set mysql_ascii_password to 1. Notice that ascii accepts dot, comma, quotes, tc, so you may want to combine this with the mysql_alphanumeric_password -->
        <stringParameter>
            <name>mysql_ascii_password</name>
            <ask>0</ask>
            <default>0</default>
            <value>0</value>
        </stringParameter>
<!-- hidden parameter -->
<stringParameter>
            <name>mysql_installation_type_options</name>
            <ask>0</ask>
            <default>bundledAndExisting</default>
            <value>bundledAndExisting</value>
        </stringParameter>

<!-- hidden parameter 
		1: The postintallation script will be run
		0: It won't be run -->
<stringParameter>
            <name>mysql_post_installation_script</name>
            <ask>0</ask>
            <default>1</default>
            <value>1</value>
        </stringParameter>

<!-- hidden parameter 
		1: Allow empty root password
		0: Don't allow empty root password -->
<stringParameter>
            <name>mysql_allow_empty_root_password</name>
            <ask>0</ask>
            <default>1</default>
            <value>1</value>
        </stringParameter>

<!-- hidden parameter 
		1: Show a warning in case the user use an empty root password
      (default) 0: Don't show a warning when the user use an empty root password -->
<stringParameter>
            <name>mysql_warn_empty_root_password</name>
            <ask>0</ask>
            <default>0</default>
            <value>0</value>
        </stringParameter>

<!-- hidden parameter (needs to be directoryParameter so .unix works)-->
<directoryParameter>
            <name>mysql_root_directory</name>
            <ask>0</ask>
            <default/>
            <value>${installdir}/mysql</value>
        </directoryParameter>

<!-- hidden parameter 
                1: Start MySQL and create the root account
                0: Only start MySQL-->
<stringParameter>
            <name>mysql_upgrade</name>
            <ask>0</ask>
            <default>0</default>
            <value>0</value>
        </stringParameter>
        <choiceParameter>
            <name>mysql_installation_type</name>
            <title>Database Installation</title>
            <explanation>Please select which database configuration you wish to use</explanation>
            <cliOptionShow>0</cliOptionShow>
            <description/>
            <displayType>radiobuttons</displayType>
            <optionList/>
            <validationActionList>
                <showQuestion>
                    <variable>continue</variable>
                    <text>Setup will try to install new databases and will overwrite any existing duplicate. Do you wish you continue?</text>
                    <ruleList>
                        <compareText text="${mysql_installation_type}" logic="equals" value="existing"/>
                    </ruleList>
                </showQuestion>
            </validationActionList>
            <postShowPageActionList>
                <exit>
                    <ruleList>
                        <compareText text="${continue}" logic="equals" value="no"/>
                    </ruleList>
                </exit>
                <setInstallerVariable name="mysql_hostname" value="127.0.0.1">
                    <ruleList>
                        <compareText text="${mysql_installation_type}" logic="equals" value="existing"/>
                    </ruleList>
                </setInstallerVariable>
            </postShowPageActionList>
        </choiceParameter>

<!-- Database information -->
<parameterGroup>
            <name>mysql_information</name>
            <explanation>Please enter your MySQL database information:</explanation>
            <title>MySQL Information</title>
            <parameterList>
                <directoryParameter>
                    <name>mysql_binary_directory</name>
                    <description>MySQL Binary Directory</description>

<!-- if the explanation is maintained, then not everything fits on the screen in xwindow mode
					<explanation>Please specify the directory where the mysql and mysqladmin binaries are located</explanation>-->
<value>${installdir.unix}/mysql/bin</value>
                    <default>${installdir.unix}/mysql/bin</default>
                    <allowEmptyValue>0</allowEmptyValue>
                    <ask>yes</ask>
                    <cliOptionShow>0</cliOptionShow>
                    <mustBeWritable>0</mustBeWritable>
                    <mustExist>1</mustExist>
                    <ruleEvaluationLogic>or</ruleEvaluationLogic>
                    <width>35</width>
                    <ruleList>
                        <compareText text="${mysql_installation_type}" logic="equals" value="existing"/>
                    </ruleList>
                    <validationActionList>
                        <throwError>
                            <text>The path ${mysql_binary_directory} seems to be invalid. Please check if the directory contains the required binaries.</text>
                            <ruleList>
                                <fileTest condition="not_exists" path="${mysql_binary_directory}/mysql.exe"/>
                                <fileTest condition="not_exists" path="${mysql_binary_directory}/mysqladmin.exe"/>
                                <platformTest type="windows"/>
                            </ruleList>
                        </throwError>
                        <throwError>
                            <text>The path ${mysql_binary_directory} seems to be invalid. Please check if the directory contains the required binaries.</text>
                            <ruleList>
                                <fileTest condition="not_exists" path="${mysql_binary_directory}/mysql"/>
                                <fileTest condition="not_exists" path="${mysql_binary_directory}/mysqladmin"/>
                                <platformTest type="unix"/>
                            </ruleList>
                        </throwError>
                    </validationActionList>
                </directoryParameter>
                <stringParameter>
                    <name>mysql_automatic_port_selection</name>
                    <ask>0</ask>
                    <default/>
                    <value>0</value>
                </stringParameter>
                <stringParameter>
                    <name>mysql_initial_port</name>
                    <ask>0</ask>
                    <default/>
                    <value>0</value>
                </stringParameter>
                <stringParameter>
                    <name>mysql_final_port</name>
                    <ask>0</ask>
                    <default/>
                    <value>0</value>
                </stringParameter>
                <stringParameter>
                    <name>mysql_hostname</name>
                    <description>IP / Hostname</description>
                    <explanation>Please enter the IP address or hostname for your database</explanation>

<!-- localhost != 127.0.0.1 on Unix (127.0.0.1 means listen on TCP, localhost in socket) -->
<value>localhost</value>
                    <default>localhost</default>
                    <allowEmptyValue>1</allowEmptyValue>
                    <ask>yes</ask>
                    <cliOptionShow>0</cliOptionShow>
                    <width>20</width>
                    <validationActionList>
                        <throwError>
                            <text>Please enter a valid IP address or hostname</text>
                            <ruleList>
                                <regExMatch text="${mysql_hostname}" pattern="^(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])$" logic="does_not_match"/>
                                <regExMatch text="${mysql_hostname}" pattern="^([a-zA-Z]([a-zA-Z0-9\-]*[a-zA-Z0-9])*\.)*[a-zA-Z]([a-zA-Z0-9\-]*[a-zA-Z0-9])*$" logic="does_not_match"/>
                            </ruleList>
                        </throwError>
                    </validationActionList>
                    <ruleList>
                        <compareText text="${mysql_installation_type}" logic="equals" value="existing"/>
                    </ruleList>
                </stringParameter>
                <stringParameter>
                    <name>mysql_server_port_show</name>
                    <ask>0</ask>
                    <default/>
                    <value>0</value>
                </stringParameter>
                <stringParameter>
                    <name>mysql_port</name>
                    <description>MySQL Server port</description>
                    <value>3306</value>
                    <default>3306</default>
                    <allowEmptyValue>1</allowEmptyValue>
                    <ask>1</ask>
                    <width>10</width>
                    <validationActionList>
                        <setInstallerVariable name="mysql_server_port_show" value="1"/>
                        <throwError>
                            <text>It seems you do not have enough permissions to bind to the port or the port is already taken by another application. Please select another one.</text>
                            <ruleEvaluationLogic>or</ruleEvaluationLogic>
                            <ruleList>
                                <ruleGroup>
                                    <ruleEvaluationLogic>and</ruleEvaluationLogic>
                                    <ruleList>
                                        <compareText text="${component(mysql).parameter(mysql_global_port_checking).value}" logic="equals" value="1"/>
                                        <compareText text="${project.parameter(reserved_ports).value}" logic="contains" value=" ${mysql_port} "/>
                                    </ruleList>
                                </ruleGroup>
                                <ruleGroup>
                                    <ruleEvaluationLogic>and</ruleEvaluationLogic>
                                    <ruleList>                                  
                                        <portTest condition="cannot_bind" port="${mysql_port}"/>
                                        <compareText text="${mysql_installation_type}" logic="equals" value="bundled"/>
                                    </ruleList>
                                </ruleGroup>
                            </ruleList>
                        </throwError>
                        <setInstallerVariable name="project.parameter(reserved_ports).value" value="${project.parameter(reserved_ports).value}mysql_port ${mysql_port} ">
                            <ruleList>
                                <compareText text="${component(mysql).parameter(mysql_global_port_checking).value}" logic="equals" value="1"/>
                            </ruleList>
                        </setInstallerVariable> 
                    </validationActionList>
                    <preShowPageActionList>
                        <setInstallerVariableFromRegEx text="${project.parameter(reserved_ports).value}" pattern="mysql_port [0-9]+ " name="project.parameter(reserved_ports).value" substitution="">
                            <ruleList>
                                <compareText text="${component(mysql).parameter(mysql_global_port_checking).value}" logic="equals" value="1"/>
                            </ruleList>
                        </setInstallerVariableFromRegEx>
                    </preShowPageActionList>
                    <ruleEvaluationLogic>or</ruleEvaluationLogic>
                    <ruleList>
                        <compareText logic="equals" value="1" text="${mysql_server_port_show}"/>
                        <ruleGroup>
                            <ruleList>
                                <compareText text="${component(mysql).parameter(mysql_global_port_checking).value}" logic="equals" value="1"/>
                                <compareText text="${project.parameter(reserved_ports).value}" logic="contains" value=" ${mysql_port} "/>
                            </ruleList>
                        </ruleGroup>
                        <compareText text="${mysql_installation_type}" logic="equals" value="existing"/>
                        <portTest condition="cannot_bind" port="${mysql_port}"/>
                    </ruleList>
                </stringParameter>
            </parameterList>
            <ruleEvaluationLogic>or</ruleEvaluationLogic>
            <ruleList>
                <compareText logic="equals" value="1" text="${mysql_server_port_show}"/>
                <compareText text="${mysql_installation_type}" logic="equals" value="existing"/>
                <portTest condition="cannot_bind" port="${mysql_port}"/>
            </ruleList>
        </parameterGroup>

 <!-- Database Credentials -->
<parameterGroup>
            <name>mysql_credentials</name>
            <explanation/>
            <title>MySQL Credentials</title>
            <parameterList>
                <stringParameter>
                    <name>mysql_root_user</name>
                    <explanation>Please enter your database root username</explanation>
                    <description>Username</description>
                    <value>root</value>
                    <default>root</default>
                    <allowEmptyValue>1</allowEmptyValue>
                    <ask>no</ask>
                    <width>30</width>
                </stringParameter>
                <passwordParameter>
                    <name>mysql_root_password</name>
                    <explanation>Please enter your database root user password</explanation>
                    <description>MySQL Server root password</description>
                    <cliOptionName>mysql_password</cliOptionName>
                    <allowEmptyValue>1</allowEmptyValue>
                    <ask>yes</ask>
                    <descriptionRetype>Re-enter password</descriptionRetype>
                    <width>30</width>
                    <validationActionList>
                        <throwError>
                            <text>Please use ascii alphanumeric characters only</text>
                            <ruleList>
                                <isTrue value="${mysql_ascii_password}" />
                                <isTrue value="${mysql_alphanumeric_password}"/>
                                <compareText text="${mysql_root_password}" logic="does_not_equal" value=""/>
                                <ruleGroup>
                                    <ruleEvaluationLogic>or</ruleEvaluationLogic>
                                    <ruleList>
                                        <stringTest text="${mysql_root_password}" type="not_ascii" />
                                        <stringTest text="${mysql_root_password}" type="not_alphanumeric"/>
                                    </ruleList>
                                </ruleGroup>
                            </ruleList>                             
                        </throwError>
                        <throwError>
                            <text>Please use alphanumeric characters only</text>
                            <ruleList>
                                <isTrue value="${mysql_alphanumeric_password}"/>
                                <stringTest text="${mysql_root_password}" type="not_alphanumeric"/>
                                <compareText text="${mysql_root_password}" logic="does_not_equal" value=""/>
                            </ruleList>
                        </throwError>
                        <throwError>
                            <text>You need to provide a non-empty password</text>
                            <ruleList>
                                <compareText text="${mysql_root_password}" logic="equals" value=""/>
                                <compareText text="${mysql_allow_empty_root_password}" logic="equals" value="0"/>
                            </ruleList>
                        </throwError>
                        <actionGroup>
                            <actionList>
                                <setInstallerVariable name="goback" value="no" />   
                                <showQuestion>
                                    <text>For security reasons it is recomended to set a non blank password for MySQL root user. Do you want to set a password for the MySQL root user?</text>
                                    <variable>goback</variable>
                                </showQuestion>
                                <setInstallerVariable name="next_page" value="mysql_credentials">
                                    <ruleList>
                                        <compareText text="${goback}" value="yes" />
                                    </ruleList>
                                </setInstallerVariable>
                            </actionList>
                            <ruleList>
                                <compareText text="${mysql_root_password}" logic="equals" value=""/>
                                <compareText text="${mysql_allow_empty_root_password}" logic="equals" value="1"/>
                                <compareText text="${mysql_warn_empty_root_password}" logic="equals" value="1"/>
                                <compareText text="${mysql_installation_type}" logic="equals" value="bundled"/>
                            </ruleList>
                        </actionGroup>
                    </validationActionList>
                    <postShowPageActionList>
                        <actionGroup>
                            <actionList>
                                <actionGroup showMessageOnError="0" abortOnError="0">
                                    <actionList>
                                <setInstallerVariable name="next_page" value="mysql_information"/>
                                <!--<mysqlDatabaseConnection 
                                    connectionId="mysql" 
                                    user="${mysql_root_user}" 
                                    password="${mysql_root_password}" 
                                    port="${mysql_port}" 
                                    host="${mysql_hostname}" />
                                    <mysqlDatabaseQuery connectionId="mysql" sql="show databases" /> -->
                                <runProgram>
                                    <program>${mysql_binary_directory}/mysql</program>
                                    <programArguments>-u root --password=${mysql_root_password.password} -P${mysql_port} -h${mysql_hostname} -e "show databases;"</programArguments>
                                    <ruleList>
                                        <platformTest type="unix"/>
                                    </ruleList>
                                </runProgram>
                                <runProgram>
                                    <program>${mysql_binary_directory}/mysql.exe</program>
                                    <programArguments>-u root --password=${mysql_root_password.password} -P${mysql_port} -h${mysql_hostname} -e "show databases;"</programArguments>
                                    <ruleList>
                                        <platformTest type="windows"/>
                                    </ruleList>
                                </runProgram>
                                <setInstallerVariable name="next_page" value=""/>
                                    </actionList>
                                </actionGroup>
                                <throwError>
                                    <abortOnError>0</abortOnError>
                                    <text>Unable to connect to database ${mysql_hostname}:${mysql_port}. Please check that the parameters are correct and your MySQL configuration accepts TCP/IP connections.</text>
                                    <ruleList>
                                        <compareText text="${next_page}" logic="does_not_equal" value=""/>
                                    </ruleList>
                                </throwError>
                            </actionList>
                            <ruleList>
                                <!-- #5135 The mysql root password didn't was asked again if it was empty -->
                                <compareText text="${mysql_installation_type}" logic="equals" value="existing"/>
                            </ruleList>
                        </actionGroup>
                    </postShowPageActionList>
                </passwordParameter>
            </parameterList>
        </parameterGroup>
        <parameterGroup>
            <name>mysql_data</name>
            <title>New Database</title>
            <description/>
            <explanation>Set the database name and user name which will be created or used.</explanation>
            <value/>
            <default/>
            <ask>1</ask>
            <cliOptionName/>
            <leftImage/>
            <parameterList>
                <stringParameter>
                    <name>mysql_database_name</name>
                    <title/>
                    <description>DB Name</description>
                    <explanation/>
                    <value>mysql_db</value>
                    <default>mysql_db</default>
                    <allowEmptyValue>0</allowEmptyValue>
                    <ask>1</ask>
                    <cliOptionName/>
                    <leftImage/>
                    <width>40</width>
                </stringParameter>
                <stringParameter>
                    <name>mysql_database_username</name>
                    <title/>
                    <description>DB User Name</description>
                    <explanation/>
                    <value>mysql_user</value>
                    <default>mysql_user</default>
                    <allowEmptyValue>0</allowEmptyValue>
                    <ask>1</ask>
                    <cliOptionName/>
                    <leftImage/>
                    <width>40</width>
                </stringParameter>
                <passwordParameter>
                    <name>mysql_database_password</name>
                    <title/>
                    <description>DB User Password</description>
                    <explanation/>
                    <value/>
                    <default/>
                    <allowEmptyValue>1</allowEmptyValue>
                    <ask>1</ask>
                    <cliOptionName/>
                    <descriptionRetype>Re-enter</descriptionRetype>
                    <leftImage/>
                    <width>40</width>
                     <validationActionList>
                                <setInstallerVariable>
                                    <name>database_name</name>
                                    <persist>0</persist>
                                    <value>${mysql_database_name}</value>
                                </setInstallerVariable>
                                <setInstallerVariable>
                                    <name>database_user</name>
                                    <persist>0</persist>
                                    <value>${mysql_database_username}</value>
                                </setInstallerVariable>
                                <setInstallerVariable>
                                    <name>database_password</name>
                                    <persist>0</persist>
                                    <value>${mysql_database_password}</value>
                                </setInstallerVariable>
                            </validationActionList>

                </passwordParameter>
            </parameterList>
        </parameterGroup>
    </parameterList>
    <readyToInstallActionList>
        <setInstallerVariable name="mysql_execute_abort_action_list" value="1" />
        <throwError>
            <text>Please use alphanumeric characters only</text>
            <ruleList>
                <isTrue value="${mysql_alphanumeric_password}"/>
                <stringTest text="${mysql_root_password}" type="not_alphanumeric"/>
                <compareText text="${mysql_root_password}" logic="does_not_equal" value=""/>
                <compareText text="${installer_ui}" value="unattended" logic="equals"/>
            </ruleList>
        </throwError>
        <throwError>
            <text>Unable to bind the mysql_port to ${mysql_port}. Please select another one.</text>
            <ruleList>
                <portTest condition="cannot_bind" port="${mysql_port}"/>
                <compareText text="${installer_ui}" logic="equals" value="unattended"/>
                <compareText text="${mysql_installation_type}" logic="equals" value="bundled"/>
                <compareText text="${component(mysql).parameter(mysql_upgrade).value}" logic="equals" value="0"/>
            </ruleList>
        </throwError>
        <setInstallerVariable name="database_vendor" value="mysql"/>
        <setInstallerVariable name="database_language" value="sql"/>
        <setInstallerVariable name="database_root_user" value="${mysql_root_user}"/>
        <setInstallerVariable name="database_root_password" value="${mysql_root_password}" persist="1"/>
        <setInstallerVariable name="database_hostname" value="${mysql_hostname}" persist="1"/>
        <setInstallerVariable name="database_port" value="${mysql_port}" persist="1"/>
        <setInstallerVariable name="database_binary_directory" value="${mysql_binary_directory}" persist="1"/>
        <setInstallerVariable name="database_installation_type" value="${mysql_installation_type}"/>
        <setInstallerVariable name="database_upgrade" value="${mysql_upgrade}"/>
        <setInstallerVariable name="mysql_port" value="${mysql_port}"/>
        <setInstallerVariable name="mysql_database_name" value="${mysql_database_name}"/>
        <setInstallerVariable name="mysql_root_password" value="${mysql_root_password}"/>
        <setInstallerVariable name="mysql_root_directory" value="${installdir}/mysql"/>
        <setInstallerVariable name="database_root_directory" value="${installdir}/mysql">
            <ruleList>
                <compareText text="${mysql_installation_type}" logic="equals" value="bundled"/>
            </ruleList>
        </setInstallerVariable>
        <setInstallerVariable name="database_name" value="${mysql_database_name}" persist="1"/>
        <setInstallerVariable name="database_user" value="${mysql_database_username}"/>
        <setInstallerVariable name="database_password" value="${mysql_database_password}"/>
        <setInstallerVariable name="database_root_directory" value="${mysql_binary_directory}/..">
            <ruleList>
                <compareText text="${mysql_installation_type}" logic="equals" value="existing"/>
            </ruleList>
        </setInstallerVariable>
        <setInstallerVariable>
            <name>database_arguments</name>
            <value>-u root</value>
            <ruleList>
                <platformTest type="windows"/>
            </ruleList>
        </setInstallerVariable>
        <setInstallerVariable>
            <name>database_arguments</name>
            <value>-u root -S ${mysql_root_directory}/tmp/mysql.sock</value>
            <ruleList>
                <platformTest type="unix"/>
            </ruleList>
        </setInstallerVariable>
        <setInstallerVariable name="database_client_binary" value="${mysql_binary_directory}/mysql" persist="1">
            <ruleList>
                <platformTest type="unix" />
            </ruleList>
        </setInstallerVariable>
        <setInstallerVariable name="database_client_binary" value="${mysql_binary_directory.unix}/mysql.exe" persist="1">
            <ruleList>
                <platformTest type="windows" />
            </ruleList>
        </setInstallerVariable>
        <setInstallerVariable name="mysql_root_directory" value="${mysql_root_directory}" persist="1"/>
        <setInstallerVariable name="MYSQL_PATH" value="${mysql_root_directory}/bin"/>
        <setInstallerVariable name="MYSQL_PATH_WIN" value="${mysql_root_directory.dos}\bin"/>
        <setInstallerVariable name="PATH" value="${MYSQL_PATH}:${PATH}"/>
        <setInstallerVariable name="PATH_WIN" value="${MYSQL_PATH_WIN};${PATH_WIN}"/>
        <setInstallerVariable name="MYSQL_LD_LIBRARY_PATH" value="${mysql_root_directory}/lib"/>
        <setInstallerVariable name="LD_LIBRARY_PATH" value="${MYSQL_LD_LIBRARY_PATH}:${LD_LIBRARY_PATH}"/>
        <setInstallerVariable name="MYSQL_DYLD_LIBRARY_PATH" value="${mysql_root_directory}/lib"/>
        <setInstallerVariable name="DYLD_LIBRARY_PATH" value="${MYSQL_DYLD_LIBRARY_PATH}:${DYLD_LIBRARY_PATH}"/>
        <setInstallerVariable name="MYSQL_ENV_VAR">
            <value>##### MYSQL ENV #####

</value>
            <ruleList>
                <platformTest type="unix"/>
            </ruleList>
        </setInstallerVariable>
        <setInstallerVariable name="MYSQL_ENV_VAR">
            <value>rem ##### MYSQL ENV #####

</value>
            <ruleList>
                <platformTest type="windows"/>
            </ruleList>
        </setInstallerVariable>
        <setInstallerVariable name="ENV_VAR">
            <value>${MYSQL_ENV_VAR}${ENV_VAR}</value>
        </setInstallerVariable>
    </readyToInstallActionList>
    <folderList>
<!-- Bundled MySQL Subcomponent -->
<folder>
            <description>Program Files</description>
            <destination>${installdir}</destination>
            <name>programfiles</name>
            <platforms>all</platforms>
            <distributionFileList>
                <distributionDirectory>
                    <origin>${mysql_distribution_folder}</origin>
                </distributionDirectory>
            </distributionFileList>
            <actionList>
                <actionGroup>
                    <actionList>
                        <substitute>
                            <files>*/mysqlaccess;*/mysqld_safe;*/mysql-log-rotate;*/mysql.spec;*/mysql-test-run;*/FrontBase.benchmark;*/safe_mysqld;*/;*/mysql.server;*/mysql_fix_privilege_tables;*/mysqld_multi</files>
                            <type>regexp</type>
                            <substitutionList>
                                <substitution>
                                    <pattern>/usr/local/mysql</pattern>
                                    <value>${installdir}/mysql</value>
                                </substitution>
                            </substitutionList>
                        </substitute>
                        <substitute>
                            <files>${mysql_root_directory}/bin/wrapper; ${mysql_root_directory}/my.cnf; ${mysql_root_directory}/bin/mysql_config</files>
                            <type>regexp</type>
                            <substitutionList>
                                <substitution>
                                    <pattern>@@BITROCK_MYSQL_PASSWORD@@</pattern>
                                    <value>${mysql_root_password}</value>
                                </substitution>
                                <substitution>
                                    <pattern>@@BITROCK_MYSQL_PORT@@</pattern>
                                    <value>${mysql_port}</value>
                                </substitution>
                                <substitution>
                                    <pattern>@@BITROCK_MYSQL_ROOTDIR@@</pattern>
                                    <value>${mysql_root_directory.unix}</value>
                                </substitution>
                            </substitutionList>
                        </substitute>
                    </actionList>
                    <ruleList>
                        <platformTest type="unix"/>
                    </ruleList>
                </actionGroup>
                <actionGroup>
                    <actionList>
                        <substitute>
                            <files>*/my.ini</files>
                            <type>regexp</type>
                            <substitutionList>
                                <substitution>
                                    <pattern>@@BITROCK_MYSQL_PORT@@</pattern>
                                    <value>${mysql_port}</value>
                                </substitution>
                                <substitution>
                                    <pattern>@@BITROCK_MYSQL_ROOTDIR@@</pattern>
                                    <value>${installdir.dos.unix}/mysql</value>
                                </substitution>
                                <substitution>
                                    <pattern>@@BITROCK_MYSQL_PASSWORD@@</pattern>
                                    <value>${mysql_root_password}</value>
                                </substitution>
                                <substitution>
                                    <pattern>user=root</pattern>
                                    <value>user=${mysql_root_user}</value>
                                </substitution>
                            </substitutionList>
                        </substitute>
                    </actionList>
                    <ruleList>
                        <platformTest type="windows"/>
                    </ruleList>
                </actionGroup>
            </actionList>
            <ruleList>
                <compareText text="${mysql_installation_type}" logic="equals" value="bundled"/>
            </ruleList>
        </folder>
    </folderList>
    <postInstallationActionList>
<!-- Linux List -->
        <actionGroup>
            <actionList>
               <actionGroup>
                    <actionList>
                        <addUser>
                            <username>mysql</username>
                            <abortOnError>0</abortOnError>
                            <showMessageOnError>1</showMessageOnError>
                            <ruleList>
                                <userTest username="mysql" logic="not_exists"/>
                            </ruleList>
                        </addUser>
                        <readFile>
                            <path>/etc/group</path>
                            <name>groupFile</name>
                        </readFile>
                        <setInstallerVariable name="mysql_group_exists" value="0" />
                        <setInstallerVariable name="mysql_group_exists" value="1" >
                            <ruleList>
                                <compareText text="${groupFile}" logic="contains" value="mysql:"/>
                            </ruleList>
                        </setInstallerVariable>
                        <addGroup>
                            <groupname>mysql</groupname>
                            <ruleList>
                                <isFalse value="${mysql_group_exists}" />
                            </ruleList>
                        </addGroup>
                        <!--addGroup>
                            <groupname>mysql</groupname>
                            <abortOnError>0</abortOnError>
                            <showMessageOnError>1</showMessageOnError>
                            <ruleList>
                                <platformTest type="solaris"/>
                            </ruleList>
                        </addGroup-->
                        <addGroupToUser>
                            <username>mysql</username>
                            <groupname>mysql</groupname>
                            <abortOnError>0</abortOnError>
                            <showMessageOnError>0</showMessageOnError>
                            <ruleList>
                                <isFalse value="${mysql_group_exists}" />
                            </ruleList>
                        </addGroupToUser>
                    </actionList>
                    <ruleList>
                        <compareText text="${installer_is_root_install}" logic="equals" value="1"/>
                    </ruleList>
                </actionGroup>
                <substitute>
                    <files>${mysql_root_directory}/scripts/myscript.sh; ${mysql_root_directory}/scripts/myscript_upgrade.sh; ${mysql_root_directory}/scripts/ctl.sh</files>
                    <substitutionList>
                        <substitution>
                            <pattern>@@BITROCK_MYSQL_PASSWORD@@</pattern>
                            <value>${mysql_root_password}</value>
                        </substitution>
                        <substitution>
                            <pattern>@@BITROCK_MYSQL_ROOTDIR@@</pattern>
                            <value>${mysql_root_directory}</value>
                        </substitution>
                        <substitution>
                            <pattern>@@BITROCK_MYSQL_PORT@@</pattern>
                            <value>${mysql_port}</value>
                        </substitution>
                    </substitutionList>
                </substitute>
            </actionList>
            <ruleList>
                <platformTest type="unix"/>
            </ruleList>
        </actionGroup>
        <actionGroup>
            <actionList>
                <runProgram progressText="Initializing MySQL Database. This could take a couple of minutes.">
                    <program>${mysql_root_directory}/scripts/myscript.sh</program>
                    <programArguments>${mysql_root_directory} ${mysql_root_password.password}</programArguments>
                    <abortOnError>0</abortOnError>
                    <showMessageOnError>1</showMessageOnError>
                </runProgram>
                <actionGroup>
                    <actionList>
                        <foreach values="1 2 3 4 5" variables="iteration">
                            <actionList>
                                <showQuestion text="Due to a lack of system resources (CPU or memory), the installation is unable to the local MySQL server. Would you like to retry to connect to the MySQL server and continue with the installation?" variable="retry_connection" >
                                    <ruleList>
                                        <isTrue value="${program_exit_code}" />
                                        <compareText text="${program_stderr}" logic="contains" value="Can't connect to local MySQL server through socket" />
                                    </ruleList>
                                </showQuestion>
                                <exit exitCode="1" >
                                    <ruleList>
                                        <isFalse value="${retry_connection}" />
                                    </ruleList>
                                </exit>    
                                <runProgram progressText="Initializing MySQL Database. This could take a couple of minutes.">
                                    <program>${mysql_root_directory}/scripts/myscript.sh</program>
                                    <programArguments>${mysql_root_directory} ${mysql_root_password.password}</programArguments>
                                    <abortOnError>0</abortOnError>
                                    <showMessageOnError>0</showMessageOnError>
                                </runProgram>
                            </actionList>
                        </foreach>
                    </actionList>
                    <ruleList>
                        <isTrue value="${program_exit_code}" />
                        <compareText text="${program_stderr}" logic="contains" value="Can't connect to local MySQL server through socket" />
                        <isTrue value="${mysql_abort_installation_on_initialization_error}" />
                    </ruleList>
                </actionGroup>
                <actionGroup>
                    <actionList>
                        <showWarning text="MySQL connection timed out. The installation has been stopped." />
                        <exit exitCode="1" />
                    </actionList>
                    <ruleList>
                        <isTrue value="${program_exit_code}" />
                        <compareText text="${program_stderr}" logic="contains" value="Can't connect to local MySQL server through socket" />
                        <isTrue value="${mysql_abort_installation_on_initialization_error}" />
                    </ruleList>
                </actionGroup>
            </actionList>
            <ruleEvaluationLogic>and</ruleEvaluationLogic>
            <ruleList>
                <platformTest type="unix"/>
                <compareText text="${component(mysql).parameter(mysql_post_installation_script).value}" logic="equals" value="1"/>
                <compareText text="${component(mysql).parameter(mysql_installation_type).value}" logic="equals" value="bundled"/>
                <compareText text="${component(mysql).parameter(mysql_upgrade).value}" logic="equals" value="0"/>
            </ruleList>
        </actionGroup>
        <actionGroup>
            <actionList>
                <runProgram progressText="Updating mysql directory permissions">
                    <program>${mysql_root_directory}/scripts/myscript_upgrade.sh</program>
                    <programArguments>${mysql_root_directory}</programArguments>
                    <abortOnError>0</abortOnError>
                    <showMessageOnError>1</showMessageOnError>
                </runProgram>
            </actionList>
            <ruleEvaluationLogic>and</ruleEvaluationLogic>
            <ruleList>
                <platformTest type="unix"/>
                <compareText text="${component(mysql).parameter(mysql_post_installation_script).value}" logic="equals" value="1"/>
                <compareText text="${component(mysql).parameter(mysql_installation_type).value}" logic="equals" value="bundled"/>
                <compareText text="${component(mysql).parameter(mysql_upgrade).value}" logic="equals" value="1"/>
            </ruleList>
        </actionGroup>
        <actionGroup>
            <actionList>
                <substitute>
                    <files>${mysql_root_directory}/scripts/myscript.bat</files>
                    <substitutionList>
                        <substitution>
                            <pattern>@@BITROCK_MYSQL_PASSWORD@@</pattern>
                            <value>${mysql_root_password}</value>
                        </substitution>
                        <substitution>
                            <pattern>@@BITROCK_MYSQL_ROOTDIR@@</pattern>
                            <value>${mysql_root_directory}</value>
                        </substitution>
                        <substitution>
                            <pattern>@@BITROCK_MYSQL_PORT@@</pattern>
                            <value>${mysql_port}</value>
                        </substitution>
                    </substitutionList>
                </substitute>
                <runProgram progressText="Initializing MySQL Database. This could take a couple of minutes.">
                    <program>${installdir.dos.unix}\mysql\bin\mysqld.exe</program>
                    <programArguments>--defaults-file=${installdir.dos}\mysql\my.ini &amp;</programArguments>
                    <abortOnError>0</abortOnError>
                    <showMessageOnError>1</showMessageOnError>
                </runProgram>
                <waitForPort port="${mysql_port}" timeout="30000" progressText="Waiting for MySQL to Start."/>
                <runProgram>
                    <program>${mysql_root_directory}/scripts/myscript.bat</program>
                    <programArguments>${mysql_root_password.password}</programArguments>
                    <abortOnError>0</abortOnError>
                    <showMessageOnError>1</showMessageOnError>
                </runProgram>
                <wait>
                    <ms>30000</ms>
                    <progressText>Configuring database</progressText>
                </wait>
                <runProgram>
                    <progressText>Shutting down MySQL</progressText>
                    <program>${installdir}\mysql\bin\mysqladmin.exe</program>
                    <programArguments>--defaults-file=${installdir.dos}\mysql\my.ini -u ${mysql_root_user} --password=${mysql_root_password.password} shutdown</programArguments>
                    <abortOnError>0</abortOnError>
                    <showMessageOnError>1</showMessageOnError>
                </runProgram>
                <wait>
                    <ms>20000</ms>
                </wait>
            </actionList>
            <ruleEvaluationLogic>and</ruleEvaluationLogic>
            <ruleList>
                <platformTest type="windows"/>
                <compareText text="${component(mysql).parameter(mysql_post_installation_script).value}" logic="does_not_equal" value="0"/>
                <compareText text="${component(mysql).parameter(mysql_installation_type).value}" logic="equals" value="bundled"/>
                <compareText text="${component(mysql).parameter(mysql_upgrade).value}" logic="equals" value="0"/>
            </ruleList>
        </actionGroup>
    </postInstallationActionList>
</component>

